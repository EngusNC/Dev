<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CoDraw PDF â€” Dessin collaboratif en temps rÃ©el</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:ital,wght@0,300;0,400;0,600;0,700;1,400&family=JetBrains+Mono:wght@400;600;700&display=swap');

  :root {
    --bg: #0c0c10;
    --surface: #16161e;
    --surface2: #1e1e2a;
    --surface3: #272736;
    --border: #2a2a3c;
    --border-hover: #3e3e56;
    --text: #e4e4f0;
    --text-dim: #7c7c98;
    --text-muted: #55556a;
    --accent: #7c6aef;
    --accent-dim: rgba(124, 106, 239, 0.15);
    --accent-glow: rgba(124, 106, 239, 0.25);
    --red: #ef6a6a;
    --green: #5ad47a;
    --yellow: #efc95a;
    --blue: #5a9def;
    --orange: #ef8c4a;
    --pink: #ef5a8c;
    --teal: #3adbc6;
    --white: #f0f0f8;
    --black: #0c0c10;
    --radius: 10px;
    --radius-sm: 6px;
    --shadow: 0 4px 24px rgba(0,0,0,0.4);
    --shadow-lg: 0 8px 48px rgba(0,0,0,0.6);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'IBM Plex Sans', -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  /*  LOBBY SCREEN                          */
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #lobby {
    position: fixed;
    inset: 0;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    background:
      radial-gradient(ellipse at 30% 40%, rgba(124,106,239,0.08) 0%, transparent 50%),
      radial-gradient(ellipse at 70% 60%, rgba(58,219,198,0.05) 0%, transparent 50%),
      var(--bg);
  }

  #lobby.hidden { display: none; }

  .lobby-card {
    width: 420px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 40px;
    box-shadow: var(--shadow-lg);
  }

  .lobby-logo {
    text-align: center;
    margin-bottom: 32px;
  }

  .lobby-logo h1 {
    font-family: 'JetBrains Mono', monospace;
    font-size: 28px;
    font-weight: 700;
    letter-spacing: -1px;
  }

  .lobby-logo h1 span { color: var(--accent); }

  .lobby-logo p {
    color: var(--text-dim);
    font-size: 14px;
    margin-top: 6px;
  }

  .lobby-field {
    margin-bottom: 16px;
  }

  .lobby-field label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-dim);
    margin-bottom: 6px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .lobby-field input {
    width: 100%;
    padding: 12px 14px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text);
    font-family: inherit;
    font-size: 15px;
    outline: none;
    transition: border-color 0.2s;
  }

  .lobby-field input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-dim);
  }

  .lobby-field input::placeholder { color: var(--text-muted); }

  .lobby-actions {
    display: flex;
    gap: 10px;
    margin-top: 24px;
  }

  .btn {
    flex: 1;
    padding: 12px 20px;
    border: none;
    border-radius: var(--radius-sm);
    font-family: inherit;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
  }

  .btn-primary {
    background: var(--accent);
    color: white;
    box-shadow: 0 2px 12px var(--accent-glow);
  }

  .btn-primary:hover {
    filter: brightness(1.1);
    transform: translateY(-1px);
  }

  .btn-secondary {
    background: var(--surface3);
    color: var(--text);
    border: 1px solid var(--border);
  }

  .btn-secondary:hover {
    background: var(--border);
  }

  .lobby-divider {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 20px 0;
    color: var(--text-muted);
    font-size: 12px;
  }

  .lobby-divider::before, .lobby-divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  .lobby-error {
    color: var(--red);
    font-size: 13px;
    margin-top: 8px;
    display: none;
  }

  .lobby-error.show { display: block; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  /*  HEADER                                */
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 16px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    z-index: 100;
    flex-shrink: 0;
    height: 48px;
  }

  .header-left {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .logo {
    font-family: 'JetBrains Mono', monospace;
    font-weight: 700;
    font-size: 15px;
    letter-spacing: -0.5px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .logo-mark {
    width: 26px; height: 26px;
    background: var(--accent);
    border-radius: 7px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    box-shadow: 0 0 16px var(--accent-glow);
  }

  .logo span { color: var(--accent); }

  .header-sep {
    width: 1px;
    height: 20px;
    background: var(--border);
  }

  .pdf-name {
    font-size: 13px;
    color: var(--text-dim);
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .room-badge {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    background: var(--accent-dim);
    color: var(--accent);
    padding: 4px 10px;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid transparent;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .room-badge:hover {
    border-color: var(--accent);
    box-shadow: 0 0 12px var(--accent-glow);
  }

  .room-badge .copy-icon { font-size: 11px; }

  .users-bar {
    display: flex;
    align-items: center;
  }

  .user-avatar {
    width: 28px; height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: 700;
    color: white;
    border: 2px solid var(--bg);
    margin-left: -6px;
    transition: transform 0.2s;
    cursor: default;
    position: relative;
  }

  .user-avatar:first-child { margin-left: 0; }
  .user-avatar:hover { transform: scale(1.15); z-index: 2; }

  .user-avatar .online-dot {
    width: 7px; height: 7px;
    background: var(--green);
    border-radius: 50%;
    border: 2px solid var(--surface);
    position: absolute;
    bottom: -1px; right: -1px;
  }

  .user-count {
    font-size: 11px;
    color: var(--text-dim);
    margin-left: 8px;
    font-family: 'JetBrains Mono', monospace;
  }

  .connection-status {
    width: 8px; height: 8px;
    border-radius: 50%;
    transition: background 0.3s;
  }

  .connection-status.connected { background: var(--green); }
  .connection-status.disconnected { background: var(--red); }
  .connection-status.connecting { background: var(--yellow); animation: pulse 1s infinite; }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  /*  MAIN LAYOUT                           */
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .main {
    display: flex;
    flex: 1;
    overflow: hidden;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  /*  TOOLBAR                               */
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .toolbar {
    width: 52px;
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 10px 0;
    gap: 2px;
    flex-shrink: 0;
  }

  .tool-btn {
    width: 36px; height: 36px;
    border: none;
    background: transparent;
    color: var(--text-dim);
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.12s;
    position: relative;
  }

  .tool-btn svg {
    width: 18px; height: 18px;
    stroke: currentColor;
    fill: none;
    stroke-width: 1.8;
    stroke-linecap: round;
    stroke-linejoin: round;
  }

  .tool-btn:hover { background: var(--surface2); color: var(--text); }

  .tool-btn.active {
    background: var(--accent);
    color: white;
    box-shadow: 0 0 14px var(--accent-glow);
  }

  .tool-btn .shortcut {
    position: absolute;
    bottom: 1px; right: 2px;
    font-size: 8px;
    font-family: 'JetBrains Mono', monospace;
    color: var(--text-muted);
    pointer-events: none;
  }

  .tool-btn.active .shortcut { color: rgba(255,255,255,0.5); }

  .tool-sep {
    width: 24px;
    height: 1px;
    background: var(--border);
    margin: 6px 0;
  }

  /* Color dots */
  .color-col {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 3px;
    margin-top: 4px;
  }

  .color-swatch {
    width: 18px; height: 18px;
    border-radius: 50%;
    border: 2px solid transparent;
    cursor: pointer;
    transition: all 0.12s;
  }

  .color-swatch:hover { transform: scale(1.2); }
  .color-swatch.active { border-color: var(--white); box-shadow: 0 0 6px rgba(255,255,255,0.25); }

  /* Size */
  .size-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    margin-top: 8px;
  }

  .size-label {
    font-size: 8px;
    color: var(--text-muted);
    font-family: 'JetBrains Mono', monospace;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .size-dot-wrap {
    width: 20px; height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .size-dot {
    border-radius: 50%;
    background: var(--text);
    transition: all 0.12s;
  }

  input[type="range"] {
    -webkit-appearance: none;
    width: 32px;
    height: 3px;
    background: var(--border);
    border-radius: 2px;
    outline: none;
  }

  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 12px; height: 12px;
    background: var(--accent);
    border-radius: 50%;
    cursor: pointer;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  /*  CANVAS AREA                           */
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .canvas-area {
    flex: 1;
    overflow: auto;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding: 24px;
    background:
      radial-gradient(ellipse at 20% 50%, rgba(124,106,239,0.03) 0%, transparent 50%),
      radial-gradient(ellipse at 80% 30%, rgba(58,219,198,0.02) 0%, transparent 50%),
      var(--bg);
    position: relative;
  }

  .canvas-wrapper {
    position: relative;
    box-shadow: var(--shadow-lg), 0 0 0 1px var(--border);
    border-radius: 3px;
    overflow: hidden;
    display: none;
  }

  #pdfCanvas { display: block; }

  #drawCanvas {
    position: absolute;
    top: 0; left: 0;
    cursor: crosshair;
  }

  /* Upload overlay */
  .upload-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 10;
  }

  .upload-overlay.hidden { display: none; }

  .upload-zone {
    width: 400px;
    height: 260px;
    border: 2px dashed var(--border);
    border-radius: 14px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 14px;
    cursor: pointer;
    transition: all 0.25s;
    background: var(--surface);
  }

  .upload-zone:hover, .upload-zone.dragover {
    border-color: var(--accent);
    background: var(--accent-dim);
    box-shadow: 0 0 40px var(--accent-glow);
  }

  .upload-icon {
    width: 48px; height: 48px;
    background: var(--surface3);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
  }

  .upload-text { font-size: 15px; font-weight: 500; color: var(--text-dim); }
  .upload-hint { font-size: 12px; color: var(--text-muted); }

  /* Remote cursors */
  .remote-cursor {
    position: absolute;
    pointer-events: none;
    z-index: 50;
    transition: left 80ms linear, top 80ms linear;
  }

  .cursor-label {
    position: absolute;
    top: 16px; left: 10px;
    font-size: 10px;
    font-weight: 600;
    padding: 2px 6px;
    border-radius: 4px;
    color: white;
    white-space: nowrap;
    font-family: 'JetBrains Mono', monospace;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  /*  BOTTOM BAR                            */
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .bottom-bar {
    position: fixed;
    bottom: 16px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    align-items: center;
    gap: 16px;
    z-index: 50;
  }

  .page-nav, .zoom-controls {
    display: flex;
    align-items: center;
    gap: 4px;
    background: var(--surface);
    padding: 5px 10px;
    border-radius: 10px;
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
  }

  .page-nav.hidden, .zoom-controls.hidden { display: none; }

  .nav-btn {
    width: 28px; height: 28px;
    border: none;
    background: transparent;
    color: var(--text);
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    transition: background 0.12s;
  }

  .nav-btn:hover { background: var(--surface3); }
  .nav-btn:disabled { opacity: 0.25; cursor: not-allowed; }

  .page-info, .zoom-level {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    color: var(--text-dim);
    padding: 0 4px;
    min-width: 40px;
    text-align: center;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  /*  CHAT                                  */
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .chat-toggle {
    position: fixed;
    bottom: 16px;
    right: 16px;
    width: 40px; height: 40px;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    font-size: 16px;
    z-index: 100;
    box-shadow: 0 2px 16px var(--accent-glow);
    transition: transform 0.15s;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .chat-toggle:hover { transform: scale(1.08); }

  .chat-badge {
    position: absolute;
    top: -4px; right: -4px;
    width: 18px; height: 18px;
    background: var(--red);
    color: white;
    border-radius: 50%;
    font-size: 10px;
    font-weight: 700;
    display: none;
    align-items: center;
    justify-content: center;
  }

  .chat-badge.show { display: flex; }

  .chat-panel {
    position: fixed;
    bottom: 66px;
    right: 16px;
    width: 280px;
    max-height: 380px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    box-shadow: var(--shadow-lg);
    z-index: 99;
    display: none;
    flex-direction: column;
    overflow: hidden;
  }

  .chat-panel.open { display: flex; }

  .chat-header {
    padding: 10px 14px;
    font-weight: 700;
    font-size: 12px;
    border-bottom: 1px solid var(--border);
    font-family: 'JetBrains Mono', monospace;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 6px;
    max-height: 260px;
  }

  .chat-msg {
    display: flex;
    gap: 8px;
    align-items: flex-start;
  }

  .chat-msg-avatar {
    width: 22px; height: 22px;
    border-radius: 50%;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 9px;
    font-weight: 700;
    color: white;
  }

  .chat-msg-body {
    font-size: 13px;
    line-height: 1.35;
    color: var(--text-dim);
  }

  .chat-msg-body .name {
    font-weight: 600;
    color: var(--text);
    font-size: 11px;
    margin-right: 6px;
  }

  .chat-input-row {
    display: flex;
    border-top: 1px solid var(--border);
  }

  .chat-input-row input {
    flex: 1;
    background: transparent;
    border: none;
    padding: 10px 12px;
    color: var(--text);
    font-family: inherit;
    font-size: 13px;
    outline: none;
  }

  .chat-input-row input::placeholder { color: var(--text-muted); }

  .chat-send-btn {
    background: var(--accent);
    color: white;
    border: none;
    padding: 0 14px;
    cursor: pointer;
    font-size: 14px;
    transition: filter 0.12s;
  }

  .chat-send-btn:hover { filter: brightness(1.15); }

  /* System messages */
  .chat-system {
    font-size: 11px;
    color: var(--text-muted);
    text-align: center;
    padding: 4px 0;
    font-style: italic;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  /*  TOAST                                 */
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .toast {
    position: fixed;
    top: 58px;
    left: 50%;
    transform: translateX(-50%) translateY(-16px);
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 8px 18px;
    border-radius: 8px;
    font-size: 13px;
    z-index: 200;
    opacity: 0;
    transition: all 0.25s;
    pointer-events: none;
    white-space: nowrap;
  }

  .toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  LOBBY                                 -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="lobby">
  <div class="lobby-card">
    <div class="lobby-logo">
      <h1>Co<span>Draw</span> PDF</h1>
      <p>Dessinez ensemble sur vos PDF, en temps rÃ©el</p>
    </div>

    <div class="lobby-field">
      <label>Votre nom</label>
      <input type="text" id="usernameInput" placeholder="Ex: Marie, Thomasâ€¦" maxlength="20" autofocus>
    </div>

    <div class="lobby-actions">
      <button class="btn btn-primary" id="createBtn" onclick="createRoom()">âœ¦ CrÃ©er une room</button>
    </div>

    <div class="lobby-divider">ou rejoindre</div>

    <div class="lobby-field">
      <label>Code de room</label>
      <input type="text" id="roomInput" placeholder="Ex: A3F2B1" maxlength="6" style="text-transform:uppercase; font-family:'JetBrains Mono',monospace; letter-spacing:2px; text-align:center;">
    </div>

    <div class="lobby-actions">
      <button class="btn btn-secondary" id="joinBtn" onclick="joinRoom()">â†’ Rejoindre</button>
    </div>

    <div class="lobby-error" id="lobbyError"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  HEADER                                -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<header>
  <div class="header-left">
    <div class="logo">
      <div class="logo-mark">âœ</div>
      Co<span>Draw</span>
    </div>
    <div class="header-sep"></div>
    <div class="pdf-name" id="pdfNameDisplay">Aucun PDF chargÃ©</div>
  </div>
  <div class="header-right">
    <div class="connection-status connecting" id="connectionStatus" title="Connexionâ€¦"></div>
    <div class="room-badge" id="roomBadge" onclick="copyRoom()" style="display:none">
      <span class="copy-icon">ğŸ“‹</span>
      <span id="roomCodeDisplay">â€”</span>
    </div>
    <div class="users-bar" id="usersBar"></div>
    <span class="user-count" id="userCount"></span>
  </div>
</header>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  MAIN                                  -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="main">
  <!-- Toolbar -->
  <div class="toolbar" id="toolbar">
    <button class="tool-btn" data-tool="select" title="SÃ©lection">
      <svg viewBox="0 0 24 24"><path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/></svg>
      <span class="shortcut">V</span>
    </button>
    <button class="tool-btn active" data-tool="pen" title="Stylo">
      <svg viewBox="0 0 24 24"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/></svg>
      <span class="shortcut">P</span>
    </button>
    <button class="tool-btn" data-tool="highlight" title="Surligneur">
      <svg viewBox="0 0 24 24"><path d="M9 11l-6 6v3h9l3-3"/><path d="M22 12l-4.6 4.6a2 2 0 01-2.8 0l-5.2-5.2a2 2 0 010-2.8L14 4"/></svg>
      <span class="shortcut">H</span>
    </button>
    <button class="tool-btn" data-tool="eraser" title="Gomme">
      <svg viewBox="0 0 24 24"><path d="M20 20H7L3 16l8-8 9 9-4 3z"/><path d="M6 11l9 9"/></svg>
      <span class="shortcut">E</span>
    </button>
    <button class="tool-btn" data-tool="line" title="Ligne">
      <svg viewBox="0 0 24 24"><line x1="5" y1="19" x2="19" y2="5"/></svg>
      <span class="shortcut">L</span>
    </button>
    <button class="tool-btn" data-tool="rect" title="Rectangle">
      <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
      <span class="shortcut">R</span>
    </button>
    <button class="tool-btn" data-tool="circle" title="Cercle">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="9"/></svg>
      <span class="shortcut">C</span>
    </button>
    <button class="tool-btn" data-tool="text" title="Texte">
      <svg viewBox="0 0 24 24"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9.5" y1="20" x2="14.5" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></svg>
      <span class="shortcut">T</span>
    </button>

    <div class="tool-sep"></div>

    <button class="tool-btn" title="Annuler (Ctrl+Z)" onclick="undo()">
      <svg viewBox="0 0 24 24"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 105.64-11.36L1 10"/></svg>
    </button>
    <button class="tool-btn" title="Tout effacer" onclick="clearPage()">
      <svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
    </button>
    <button class="tool-btn" title="Exporter PNG" onclick="exportPNG()">
      <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
    </button>

    <div class="tool-sep"></div>

    <div class="color-col" id="colorCol"></div>

    <div class="size-section">
      <span class="size-label">Size</span>
      <div class="size-dot-wrap"><div class="size-dot" id="sizeDot"></div></div>
      <input type="range" id="sizeSlider" min="1" max="30" value="3">
    </div>
  </div>

  <!-- Canvas area -->
  <div class="canvas-area" id="canvasArea">
    <div class="upload-overlay" id="uploadOverlay">
      <div class="upload-zone" id="uploadZone">
        <div class="upload-icon">ğŸ“„</div>
        <div class="upload-text">Glissez un PDF ici</div>
        <div class="upload-hint">ou cliquez pour parcourir Â· partagÃ© avec toute la room</div>
      </div>
      <input type="file" id="fileInput" accept=".pdf" style="display:none">
    </div>

    <div class="canvas-wrapper" id="canvasWrapper">
      <canvas id="pdfCanvas"></canvas>
      <canvas id="drawCanvas"></canvas>
    </div>
  </div>
</div>

<!-- Bottom bar -->
<div class="bottom-bar">
  <div class="page-nav hidden" id="pageNav">
    <button class="nav-btn" id="prevPage" onclick="changePage(-1)">â—€</button>
    <span class="page-info" id="pageInfo">1/1</span>
    <button class="nav-btn" id="nextPage" onclick="changePage(1)">â–¶</button>
  </div>
  <div class="zoom-controls hidden" id="zoomControls">
    <button class="nav-btn" onclick="changeZoom(-0.15)">âˆ’</button>
    <span class="zoom-level" id="zoomLevel">100%</span>
    <button class="nav-btn" onclick="changeZoom(0.15)">+</button>
    <button class="nav-btn" onclick="changeZoom(0,true)" title="Reset">âŸ²</button>
  </div>
</div>

<!-- Chat -->
<button class="chat-toggle" onclick="toggleChat()">ğŸ’¬<span class="chat-badge" id="chatBadge">0</span></button>
<div class="chat-panel" id="chatPanel">
  <div class="chat-header">Chat</div>
  <div class="chat-messages" id="chatMessages"></div>
  <div class="chat-input-row">
    <input type="text" id="chatInput" placeholder="Messageâ€¦" onkeydown="if(event.key==='Enter')sendChat()">
    <button class="chat-send-btn" onclick="sendChat()">â¤</button>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  SCRIPT                                -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let socket = null;
let myUser = null;
let roomId = null;
let pdfDoc = null;
let currentPage = 1;
let totalPages = 0;
let zoom = 1.0;
let currentTool = 'pen';
let currentColor = '#7c6aef';
let currentSize = 3;
let isDrawing = false;
let startX = 0, startY = 0;
let strokes = {};
let currentStroke = null;
let chatOpen = false;
let unreadChat = 0;
let remoteCursors = {};
let remoteDrawing = {}; // userId -> in-progress stroke

const COLORS = [
  '#7c6aef', '#ef6a6a', '#5a9def', '#5ad47a',
  '#efc95a', '#ef8c4a', '#ef5a8c', '#f0f0f8', '#2a2a3c'
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SOCKET.IO CONNECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function connectSocket() {
  socket = io();

  socket.on('connect', () => {
    setConnectionStatus('connected');
    console.log('[Socket] Connected:', socket.id);
  });

  socket.on('disconnect', () => {
    setConnectionStatus('disconnected');
  });

  socket.on('reconnect_attempt', () => {
    setConnectionStatus('connecting');
  });

  // â”€â”€ User events â”€â”€
  socket.on('user-joined', (user) => {
    addSystemChat(`${user.username} a rejoint la room`);
    showToast(`ğŸ‘‹ ${user.username} a rejoint`);
    refreshUsers();
  });

  socket.on('user-left', ({ username }) => {
    addSystemChat(`${username} a quittÃ© la room`);
    refreshUsers();
    // Remove their cursor
    Object.keys(remoteCursors).forEach(uid => {
      if (remoteCursors[uid]?.username === username) {
        remoteCursors[uid].el?.remove();
        delete remoteCursors[uid];
      }
    });
  });

  // â”€â”€ PDF shared by another user â”€â”€
  socket.on('pdf-shared', async ({ pdfBase64, pdfName, totalPages: tp }) => {
    showToast(`ğŸ“„ PDF partagÃ©: ${pdfName}`);
    await loadPDFFromBase64(pdfBase64, pdfName, tp);
  });

  // â”€â”€ Remote stroke events â”€â”€
  socket.on('stroke-start', ({ userId, tool, color, size, opacity, x, y }) => {
    remoteDrawing[userId] = {
      tool, color, size, opacity,
      points: [{ x, y }]
    };
  });

  socket.on('stroke-move', ({ userId, x, y }) => {
    if (!remoteDrawing[userId]) return;
    remoteDrawing[userId].points.push({ x, y });
    redrawAll();
  });

  socket.on('stroke-end', ({ page, stroke }) => {
    delete remoteDrawing[stroke.userId];
    if (!strokes[page]) strokes[page] = [];
    strokes[page].push(stroke);
    if (page === currentPage) redrawAll();
  });

  socket.on('add-shape', ({ page, shape }) => {
    if (!strokes[page]) strokes[page] = [];
    strokes[page].push(shape);
    if (page === currentPage) redrawAll();
  });

  socket.on('page-strokes', ({ page, strokes: newStrokes }) => {
    strokes[page] = newStrokes;
    if (page === currentPage) redrawAll();
  });

  // â”€â”€ Cursor â”€â”€
  socket.on('cursor-move', ({ userId, username, color, initials, x, y, page }) => {
    if (page !== currentPage) {
      if (remoteCursors[userId]?.el) remoteCursors[userId].el.style.display = 'none';
      return;
    }
    updateRemoteCursor(userId, username, color, initials, x, y);
  });

  socket.on('user-page-change', ({ userId, username, page }) => {
    if (remoteCursors[userId]?.el) {
      remoteCursors[userId].el.style.display = (page === currentPage) ? '' : 'none';
    }
  });

  // â”€â”€ Chat â”€â”€
  socket.on('chat-message', (msg) => {
    addChatMsg(msg);
    if (!chatOpen) {
      unreadChat++;
      updateChatBadge();
    }
  });
}

function setConnectionStatus(status) {
  const el = document.getElementById('connectionStatus');
  el.className = 'connection-status ' + status;
  el.title = { connected: 'ConnectÃ©', disconnected: 'DÃ©connectÃ©', connecting: 'Connexionâ€¦' }[status];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOBBY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getUsername() {
  const v = document.getElementById('usernameInput').value.trim();
  if (!v) {
    showLobbyError('Entrez votre nom');
    return null;
  }
  return v;
}

function showLobbyError(msg) {
  const el = document.getElementById('lobbyError');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 3000);
}

function createRoom() {
  const username = getUsername();
  if (!username) return;

  connectSocket();
  socket.emit('create-room', { username }, (res) => {
    myUser = res.user;
    roomId = res.roomId;
    enterApp(res);
  });
}

function joinRoom() {
  const username = getUsername();
  if (!username) return;

  const code = document.getElementById('roomInput').value.trim().toUpperCase();
  if (!code || code.length < 4) {
    showLobbyError('Entrez un code de room valide');
    return;
  }

  connectSocket();
  socket.emit('join-room', { roomId: code, username }, async (res) => {
    if (res.error) {
      showLobbyError(res.error);
      return;
    }
    myUser = res.user;
    roomId = res.roomId;
    strokes = res.strokes || {};
    enterApp(res);

    // Load shared PDF if any
    if (res.pdfData) {
      await loadPDFFromBase64(res.pdfData, res.pdfName, res.totalPages);
    }
  });
}

function enterApp(res) {
  document.getElementById('lobby').classList.add('hidden');
  document.getElementById('roomBadge').style.display = '';
  document.getElementById('roomCodeDisplay').textContent = roomId;
  refreshUsers();
  addSystemChat(`Bienvenue dans la room ${roomId}`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  USERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function refreshUsers() {
  if (!socket || !roomId) return;
  // We track users from events; for simplicity re-render from room state
  // The server sends full user list on join; after that we track joins/leaves
}

function renderUsers(users) {
  const bar = document.getElementById('usersBar');
  bar.innerHTML = '';
  users.forEach(u => {
    const av = document.createElement('div');
    av.className = 'user-avatar';
    av.style.background = u.color;
    av.title = u.username + (u.id === myUser?.id ? ' (vous)' : '');
    av.textContent = u.initials;
    const dot = document.createElement('div');
    dot.className = 'online-dot';
    av.appendChild(dot);
    bar.appendChild(av);
  });
  document.getElementById('userCount').textContent = users.length + ' en ligne';
}

// Track users locally
let knownUsers = [];
const origCreateRoom = createRoom;
const origJoinRoom = joinRoom;

// Override enterApp to set users
const _enterApp = enterApp;
enterApp = function(res) {
  knownUsers = res.users || [];
  renderUsers(knownUsers);
  _enterApp(res);
};

socket_onUserJoined_orig = null;
function setupUserTracking() {
  socket.on('user-joined', (user) => {
    if (!knownUsers.find(u => u.id === user.id)) knownUsers.push(user);
    renderUsers(knownUsers);
  });
  socket.on('user-left', ({ userId }) => {
    knownUsers = knownUsers.filter(u => u.id !== userId);
    renderUsers(knownUsers);
  });
}

// Patch connectSocket
const _connectSocket = connectSocket;
connectSocket = function() {
  _connectSocket();
  setupUserTracking();
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PDF LOADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setupUpload() {
  const zone = document.getElementById('uploadZone');
  const input = document.getElementById('fileInput');

  zone.onclick = () => input.click();
  input.onchange = (e) => { if (e.target.files[0]) handlePDFFile(e.target.files[0]); };

  zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('dragover'); });
  zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
  zone.addEventListener('drop', (e) => {
    e.preventDefault();
    zone.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file && file.type === 'application/pdf') handlePDFFile(file);
  });
}

async function handlePDFFile(file) {
  const arrayBuffer = await file.arrayBuffer();
  const uint8 = new Uint8Array(arrayBuffer);

  // Convert to base64 for sharing
  let binary = '';
  for (let i = 0; i < uint8.length; i++) binary += String.fromCharCode(uint8[i]);
  const base64 = btoa(binary);

  pdfDoc = await pdfjsLib.getDocument({ data: uint8 }).promise;
  totalPages = pdfDoc.numPages;
  currentPage = 1;
  strokes = {};

  showPDF(file.name);

  // Share with room
  if (socket && roomId) {
    socket.emit('share-pdf', { pdfBase64: base64, pdfName: file.name, totalPages });
  }

  showToast(`ğŸ“„ ${file.name} â€” ${totalPages} page(s)`);
}

async function loadPDFFromBase64(base64, name, tp) {
  const binary = atob(base64);
  const uint8 = new Uint8Array(binary.length);
  for (let i = 0; i < binary.length; i++) uint8[i] = binary.charCodeAt(i);

  pdfDoc = await pdfjsLib.getDocument({ data: uint8 }).promise;
  totalPages = tp || pdfDoc.numPages;
  currentPage = 1;

  showPDF(name);
}

function showPDF(name) {
  document.getElementById('uploadOverlay').classList.add('hidden');
  document.getElementById('canvasWrapper').style.display = 'block';
  document.getElementById('pageNav').classList.remove('hidden');
  document.getElementById('zoomControls').classList.remove('hidden');
  document.getElementById('pdfNameDisplay').textContent = name || 'PDF';
  renderPage();
}

async function renderPage() {
  if (!pdfDoc) return;
  const page = await pdfDoc.getPage(currentPage);
  const viewport = page.getViewport({ scale: zoom * 1.5 });

  const pdfCanvas = document.getElementById('pdfCanvas');
  const drawCanvas = document.getElementById('drawCanvas');

  pdfCanvas.width = viewport.width;
  pdfCanvas.height = viewport.height;
  drawCanvas.width = viewport.width;
  drawCanvas.height = viewport.height;

  await page.render({ canvasContext: pdfCanvas.getContext('2d'), viewport }).promise;

  document.getElementById('pageInfo').textContent = `${currentPage}/${totalPages}`;
  document.getElementById('prevPage').disabled = currentPage <= 1;
  document.getElementById('nextPage').disabled = currentPage >= totalPages;
  document.getElementById('zoomLevel').textContent = Math.round(zoom * 100) + '%';

  redrawAll();
}

function changePage(delta) {
  const p = currentPage + delta;
  if (p >= 1 && p <= totalPages) {
    currentPage = p;
    renderPage();
    if (socket) socket.emit('page-change', { page: currentPage });
  }
}

function changeZoom(delta, reset) {
  zoom = reset ? 1.0 : Math.max(0.3, Math.min(3, zoom + delta));
  renderPage();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DRAWING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setupDrawing() {
  const dc = document.getElementById('drawCanvas');

  dc.addEventListener('pointerdown', (e) => {
    if (currentTool === 'select') return;

    if (currentTool === 'text') {
      const text = prompt('Texte Ã  ajouter :');
      if (!text) return;
      const rect = dc.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      const shape = { tool: 'text', color: currentColor, size: currentSize * 5, text, x, y };
      pushStroke(shape);
      if (socket) socket.emit('add-shape', { page: currentPage, shape });
      redrawAll();
      return;
    }

    isDrawing = true;
    const rect = dc.getBoundingClientRect();
    startX = e.clientX - rect.left;
    startY = e.clientY - rect.top;

    if (currentTool === 'pen' || currentTool === 'highlight' || currentTool === 'eraser') {
      currentStroke = {
        tool: currentTool,
        color: currentTool === 'eraser' ? '#000' : currentColor,
        size: currentTool === 'eraser' ? currentSize * 4 : currentSize,
        opacity: currentTool === 'highlight' ? 0.35 : 1,
        points: [{ x: startX, y: startY }]
      };

      if (socket && currentTool !== 'eraser') {
        socket.emit('stroke-start', {
          tool: currentTool,
          color: currentStroke.color,
          size: currentStroke.size,
          opacity: currentStroke.opacity,
          x: startX, y: startY
        });
      }
    }

    dc.setPointerCapture(e.pointerId);
  });

  dc.addEventListener('pointermove', (e) => {
    const rect = dc.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    // Send cursor position
    if (socket && pdfDoc) {
      socket.emit('cursor-move', { x, y, page: currentPage });
    }

    if (!isDrawing) return;

    if (currentStroke && (currentTool === 'pen' || currentTool === 'highlight' || currentTool === 'eraser')) {
      currentStroke.points.push({ x, y });
      redrawAll();
      drawStroke(document.getElementById('drawCanvas').getContext('2d'), currentStroke);

      if (socket && currentTool !== 'eraser') {
        socket.emit('stroke-move', { x, y });
      }
    } else if (['line', 'rect', 'circle'].includes(currentTool)) {
      redrawAll();
      drawShapePreview(document.getElementById('drawCanvas').getContext('2d'), x, y);
    }
  });

  dc.addEventListener('pointerup', (e) => {
    if (!isDrawing) return;
    isDrawing = false;
    const rect = dc.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    let finalStroke = null;

    if (currentTool === 'pen' || currentTool === 'highlight') {
      finalStroke = currentStroke;
    } else if (currentTool === 'eraser') {
      eraseAt(currentStroke.points);
      currentStroke = null;
      redrawAll();
      return;
    } else if (currentTool === 'line') {
      finalStroke = { tool: 'line', color: currentColor, size: currentSize, opacity: 1, x1: startX, y1: startY, x2: x, y2: y };
    } else if (currentTool === 'rect') {
      finalStroke = { tool: 'rect', color: currentColor, size: currentSize, opacity: 1, x1: startX, y1: startY, x2: x, y2: y };
    } else if (currentTool === 'circle') {
      finalStroke = { tool: 'circle', color: currentColor, size: currentSize, opacity: 1, cx: (startX+x)/2, cy: (startY+y)/2, rx: Math.abs(x-startX)/2, ry: Math.abs(y-startY)/2 };
    }

    if (finalStroke) {
      pushStroke(finalStroke);

      if (socket) {
        if (finalStroke.points) {
          socket.emit('stroke-end', { page: currentPage, stroke: finalStroke });
        } else {
          socket.emit('add-shape', { page: currentPage, shape: finalStroke });
        }
      }
    }

    currentStroke = null;
    redrawAll();
  });
}

function pushStroke(stroke) {
  if (!strokes[currentPage]) strokes[currentPage] = [];
  strokes[currentPage].push(stroke);
}

function eraseAt(points) {
  if (!strokes[currentPage]) return;
  const before = strokes[currentPage].length;
  strokes[currentPage] = strokes[currentPage].filter(s => {
    if (s.points) {
      return !s.points.some(sp =>
        points.some(ep => Math.hypot(sp.x - ep.x, sp.y - ep.y) < 20)
      );
    }
    return true;
  });
  if (strokes[currentPage].length !== before && socket) {
    // Sync full page state after erase
    socket.emit('clear-page', { page: currentPage }); // simplified
    strokes[currentPage].forEach(s => {
      socket.emit('add-shape', { page: currentPage, shape: s });
    });
  }
}

function undo() {
  if (strokes[currentPage]?.length > 0) {
    // Remove last own stroke
    for (let i = strokes[currentPage].length - 1; i >= 0; i--) {
      const s = strokes[currentPage][i];
      if (!s.userId || s.userId === myUser?.id || s.userId === socket?.id) {
        strokes[currentPage].splice(i, 1);
        break;
      }
    }
    redrawAll();
    if (socket) socket.emit('undo', { page: currentPage });
  }
}

function clearPage() {
  if (!confirm('Effacer tous les dessins de cette page ?')) return;
  strokes[currentPage] = [];
  redrawAll();
  if (socket) socket.emit('clear-page', { page: currentPage });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function redrawAll() {
  const dc = document.getElementById('drawCanvas');
  const ctx = dc.getContext('2d');
  ctx.clearRect(0, 0, dc.width, dc.height);

  // Draw committed strokes
  (strokes[currentPage] || []).forEach(s => drawStroke(ctx, s));

  // Draw remote in-progress strokes
  Object.values(remoteDrawing).forEach(s => {
    if (s.points?.length > 1) drawStroke(ctx, s);
  });
}

function drawStroke(ctx, s) {
  ctx.save();
  ctx.globalAlpha = s.opacity || 1;
  ctx.strokeStyle = s.color;
  ctx.fillStyle = s.color;
  ctx.lineWidth = s.size;
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';

  if (s.tool === 'pen' || s.tool === 'highlight') {
    if (s.points?.length > 1) {
      ctx.beginPath();
      ctx.moveTo(s.points[0].x, s.points[0].y);
      for (let i = 1; i < s.points.length; i++) {
        const p0 = s.points[i - 1], p1 = s.points[i];
        const mx = (p0.x + p1.x) / 2, my = (p0.y + p1.y) / 2;
        ctx.quadraticCurveTo(p0.x, p0.y, mx, my);
      }
      ctx.stroke();
    }
  } else if (s.tool === 'line') {
    ctx.beginPath();
    ctx.moveTo(s.x1, s.y1);
    ctx.lineTo(s.x2, s.y2);
    ctx.stroke();
  } else if (s.tool === 'rect') {
    ctx.beginPath();
    ctx.rect(s.x1, s.y1, s.x2 - s.x1, s.y2 - s.y1);
    ctx.stroke();
  } else if (s.tool === 'circle') {
    ctx.beginPath();
    ctx.ellipse(s.cx, s.cy, Math.max(1, s.rx), Math.max(1, s.ry), 0, 0, Math.PI * 2);
    ctx.stroke();
  } else if (s.tool === 'text') {
    ctx.font = `${s.size}px 'IBM Plex Sans', sans-serif`;
    ctx.fillText(s.text, s.x, s.y);
  }

  ctx.restore();
}

function drawShapePreview(ctx, x, y) {
  ctx.save();
  ctx.strokeStyle = currentColor;
  ctx.lineWidth = currentSize;
  ctx.setLineDash([5, 4]);
  ctx.lineCap = 'round';

  if (currentTool === 'line') {
    ctx.beginPath(); ctx.moveTo(startX, startY); ctx.lineTo(x, y); ctx.stroke();
  } else if (currentTool === 'rect') {
    ctx.beginPath(); ctx.rect(startX, startY, x - startX, y - startY); ctx.stroke();
  } else if (currentTool === 'circle') {
    ctx.beginPath();
    ctx.ellipse((startX+x)/2, (startY+y)/2, Math.abs(x-startX)/2, Math.abs(y-startY)/2, 0, 0, Math.PI*2);
    ctx.stroke();
  }

  ctx.restore();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  REMOTE CURSORS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateRemoteCursor(userId, username, color, initials, x, y) {
  if (!remoteCursors[userId]) {
    const el = document.createElement('div');
    el.className = 'remote-cursor';
    el.innerHTML = `
      <svg width="14" height="18" viewBox="0 0 14 18" fill="${color}">
        <path d="M0 0l14 10.5-6 1-3 6.5z"/>
      </svg>
      <div class="cursor-label" style="background:${color}">${username}</div>
    `;
    document.getElementById('canvasArea').appendChild(el);
    remoteCursors[userId] = { el, username };
  }

  const wrapper = document.getElementById('canvasWrapper');
  const area = document.getElementById('canvasArea');
  const wr = wrapper.getBoundingClientRect();
  const ar = area.getBoundingClientRect();

  const cursor = remoteCursors[userId].el;
  cursor.style.display = '';
  cursor.style.left = (wr.left - ar.left + x) + 'px';
  cursor.style.top = (wr.top - ar.top + y) + 'px';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOOLBAR SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setupToolbar() {
  document.querySelectorAll('.tool-btn[data-tool]').forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll('.tool-btn[data-tool]').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentTool = btn.dataset.tool;
      updateCursor();
    };
  });

  document.getElementById('sizeSlider').oninput = (e) => {
    currentSize = parseInt(e.target.value);
    updateSizeDot();
  };
}

function updateCursor() {
  const dc = document.getElementById('drawCanvas');
  const cursors = { select: 'default', eraser: 'cell', text: 'text' };
  dc.style.cursor = cursors[currentTool] || 'crosshair';
}

function updateSizeDot() {
  const dot = document.getElementById('sizeDot');
  const s = Math.max(4, currentSize * 1.5);
  dot.style.width = s + 'px';
  dot.style.height = s + 'px';
}

function renderColors() {
  const col = document.getElementById('colorCol');
  COLORS.forEach(hex => {
    const sw = document.createElement('div');
    sw.className = 'color-swatch' + (hex === currentColor ? ' active' : '');
    sw.style.background = hex;
    if (hex === '#f0f0f8' || hex === '#2a2a3c') sw.style.border = '1px solid var(--border)';
    sw.onclick = () => {
      document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
      sw.classList.add('active');
      currentColor = hex;
    };
    col.appendChild(sw);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KEYBOARD SHORTCUTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setupKeyboard() {
  document.addEventListener('keydown', (e) => {
    if (e.target.tagName === 'INPUT') return;
    const key = e.key.toLowerCase();
    if (e.ctrlKey && key === 'z') { e.preventDefault(); undo(); return; }
    const map = { v:'select', p:'pen', h:'highlight', e:'eraser', l:'line', r:'rect', c:'circle', t:'text' };
    if (map[key]) {
      document.querySelectorAll('.tool-btn[data-tool]').forEach(b => b.classList.remove('active'));
      document.querySelector(`[data-tool="${map[key]}"]`)?.classList.add('active');
      currentTool = map[key];
      updateCursor();
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleChat() {
  chatOpen = !chatOpen;
  document.getElementById('chatPanel').classList.toggle('open', chatOpen);
  if (chatOpen) {
    unreadChat = 0;
    updateChatBadge();
    document.getElementById('chatInput').focus();
  }
}

function sendChat() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text || !socket) return;
  socket.emit('chat-message', { text });
  input.value = '';
}

function addChatMsg(msg) {
  const container = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = 'chat-msg';
  div.innerHTML = `
    <div class="chat-msg-avatar" style="background:${msg.color}">${msg.initials}</div>
    <div class="chat-msg-body">
      <span class="name">${msg.username}</span>${escapeHtml(msg.text)}
    </div>
  `;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

function addSystemChat(text) {
  const container = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = 'chat-system';
  div.textContent = text;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

function updateChatBadge() {
  const badge = document.getElementById('chatBadge');
  if (unreadChat > 0) {
    badge.textContent = unreadChat;
    badge.classList.add('show');
  } else {
    badge.classList.remove('show');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportPNG() {
  const pdfC = document.getElementById('pdfCanvas');
  const drawC = document.getElementById('drawCanvas');
  const merged = document.createElement('canvas');
  merged.width = pdfC.width;
  merged.height = pdfC.height;
  const ctx = merged.getContext('2d');
  ctx.drawImage(pdfC, 0, 0);
  ctx.drawImage(drawC, 0, 0);

  const link = document.createElement('a');
  link.download = `codraw-page${currentPage}.png`;
  link.href = merged.toDataURL();
  link.click();
  showToast('ğŸ’¾ Image exportÃ©e');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

function copyRoom() {
  navigator.clipboard?.writeText(roomId);
  showToast('ğŸ“‹ Code copiÃ© : ' + roomId);
}

function escapeHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOBBY ENTER KEY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('usernameInput').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') createRoom();
});
document.getElementById('roomInput').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') joinRoom();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
renderColors();
setupUpload();
setupToolbar();
setupDrawing();
setupKeyboard();
updateSizeDot();
</script>
</body>
</html>
